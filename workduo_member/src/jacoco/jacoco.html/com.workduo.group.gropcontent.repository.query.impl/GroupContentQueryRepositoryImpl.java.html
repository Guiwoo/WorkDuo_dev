<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GroupContentQueryRepositoryImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">workduo</a> &gt; <a href="index.source.html" class="el_package">com.workduo.group.gropcontent.repository.query.impl</a> &gt; <span class="el_source">GroupContentQueryRepositoryImpl.java</span></div><h1>GroupContentQueryRepositoryImpl.java</h1><pre class="source lang-java linenums">package com.workduo.group.gropcontent.repository.query.impl;

import com.querydsl.core.types.Order;
import com.querydsl.core.types.OrderSpecifier;
import com.querydsl.core.types.dsl.BooleanExpression;
import com.querydsl.core.types.dsl.Expressions;
import com.querydsl.core.types.dsl.StringPath;
import com.querydsl.jpa.impl.JPAQuery;
import com.querydsl.jpa.impl.JPAQueryFactory;
import com.workduo.group.gropcontent.dto.detailgroupcontent.*;
import com.workduo.group.gropcontent.repository.query.GroupContentQueryRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.data.support.PageableExecutionUtils;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import static com.querydsl.core.types.Order.ASC;
import static com.querydsl.core.types.Order.DESC;
import static com.querydsl.jpa.JPAExpressions.select;
import static com.workduo.group.gropcontent.entity.QGroupContent.groupContent;
import static com.workduo.group.gropcontent.entity.QGroupContentComment.groupContentComment;
import static com.workduo.group.gropcontent.entity.QGroupContentCommentLike.groupContentCommentLike;
import static com.workduo.group.gropcontent.entity.QGroupContentImage.groupContentImage;
import static com.workduo.group.gropcontent.entity.QGroupContentLike.groupContentLike;
import static com.workduo.member.member.entity.QMember.member;

@Service
<span class="nc" id="L34">@RequiredArgsConstructor</span>
public class GroupContentQueryRepositoryImpl implements GroupContentQueryRepository {

    private final JPAQueryFactory jpaQueryFactory;

    @Override
    public Page&lt;GroupContentDto&gt; findByGroupContentList(
            Pageable pageable,
            Long groupId) {
<span class="nc" id="L43">        List&lt;GroupContentDto&gt; content = jpaQueryFactory</span>
<span class="nc" id="L44">                .select(</span>
                        new QGroupContentDto(
                                groupContent.id,
                                groupContent.title,
                                groupContent.content,
<span class="nc" id="L49">                                member.id.as(&quot;memberId&quot;),</span>
                                member.username,
                                member.nickname,
                                member.profileImg,
                                groupContent.deletedYn,
                                groupContent.createdAt,
<span class="nc" id="L55">                                Expressions.as(</span>
<span class="nc" id="L56">                                        select(groupContentLike.count())</span>
<span class="nc" id="L57">                                                .from(groupContentLike)</span>
<span class="nc" id="L58">                                                .where(</span>
                                                        groupContentLike
                                                                .groupContent
<span class="nc" id="L61">                                                                .eq(groupContent)</span>
                                                )
                                        , &quot;contentLike&quot;
                                )
                        )
                )
<span class="nc" id="L67">                .distinct()</span>
<span class="nc" id="L68">                .from(groupContent)</span>
<span class="nc" id="L69">                .join(groupContent.member, member)</span>
<span class="nc" id="L70">                .where(</span>
<span class="nc" id="L71">                        contentIsDelYn(),</span>
<span class="nc" id="L72">                        groupEq(groupId)</span>
                )
<span class="nc" id="L74">                .offset(pageable.getOffset())</span>
<span class="nc" id="L75">                .limit(pageable.getPageSize())</span>
<span class="nc" id="L76">                .orderBy(findByGroupContentListSort(pageable).stream()</span>
<span class="nc" id="L77">                        .toArray(OrderSpecifier[]::new))</span>
<span class="nc" id="L78">                .fetch();</span>

<span class="nc" id="L80">        JPAQuery&lt;Long&gt; countQuery = jpaQueryFactory</span>
<span class="nc" id="L81">                .select(groupContent.count())</span>
<span class="nc" id="L82">                .from(groupContent)</span>
<span class="nc" id="L83">                .where(</span>
<span class="nc" id="L84">                        contentIsDelYn(),</span>
<span class="nc" id="L85">                        groupEq(groupId)</span>
                );


<span class="nc" id="L89">        return PageableExecutionUtils.getPage(</span>
                content,
                pageable,
<span class="nc" id="L92">                countQuery::fetchOne</span>
        );
    }

    @Override
    public Optional&lt;GroupContentDto&gt; findByGroupContent(Long groupId, Long groupContentId) {
<span class="nc" id="L98">        return Optional.ofNullable(jpaQueryFactory</span>
<span class="nc" id="L99">                .select(</span>
                        new QGroupContentDto(
                                groupContent.id,
                                groupContent.title,
                                groupContent.content,
<span class="nc" id="L104">                                member.id.as(&quot;memberId&quot;),</span>
                                member.username,
                                member.nickname,
                                member.profileImg,
                                groupContent.deletedYn,
                                groupContent.createdAt,
<span class="nc" id="L110">                                Expressions.as(</span>
<span class="nc" id="L111">                                        select(groupContentLike.count())</span>
<span class="nc" id="L112">                                                .from(groupContentLike)</span>
<span class="nc" id="L113">                                                .where(</span>
                                                        groupContentLike
                                                                .groupContent
<span class="nc" id="L116">                                                                .eq(groupContent)</span>
                                                )
                                        , &quot;contentLike&quot;
                                )
                        )
                )
<span class="nc" id="L122">                .distinct()</span>
<span class="nc" id="L123">                .from(groupContent)</span>
<span class="nc" id="L124">                .join(groupContent.member, member)</span>
<span class="nc" id="L125">                .where(</span>
<span class="nc" id="L126">                        groupContentEq(groupContentId),</span>
<span class="nc" id="L127">                        groupEq(groupId)</span>
                )
<span class="nc" id="L129">                .fetchOne()</span>
        );
    }

    @Override
    public List&lt;GroupContentImageDto&gt; findByGroupContentImage(Long groupId, Long groupContentId) {
<span class="nc" id="L135">        return jpaQueryFactory</span>
<span class="nc" id="L136">                .select(</span>
                        new QGroupContentImageDto(
                                groupContentImage.id,
                                groupContentImage.imagePath
                        )
                )
<span class="nc" id="L142">                .from(groupContentImage)</span>
<span class="nc" id="L143">                .where(</span>
<span class="nc" id="L144">                        groupContentImage.groupContent.id.eq(groupContentId),</span>
<span class="nc" id="L145">                        groupEq(groupId)</span>
                )
<span class="nc" id="L147">                .fetch();</span>
    }

    @Override
    public Page&lt;GroupContentCommentDto&gt; findByGroupContentComments(
            Pageable pageable,
            Long groupId,
            Long groupContentId) {
<span class="nc" id="L155">        List&lt;GroupContentCommentDto&gt; content = jpaQueryFactory</span>
<span class="nc" id="L156">                .select(</span>
                        new QGroupContentCommentDto(
<span class="nc" id="L158">                                groupContentComment.id.as(&quot;commentId&quot;),</span>
<span class="nc" id="L159">                                member.id.as(&quot;memberId&quot;),</span>
<span class="nc" id="L160">                                member.username.as(&quot;username&quot;),</span>
<span class="nc" id="L161">                                member.nickname.as(&quot;nickname&quot;),</span>
<span class="nc" id="L162">                                member.profileImg.as(&quot;profileImg&quot;),</span>
<span class="nc" id="L163">                                groupContent.id.as(&quot;groupContentId&quot;),</span>
<span class="nc" id="L164">                                groupContentComment.comment.as(&quot;content&quot;),</span>
<span class="nc" id="L165">                                groupContentComment.createdAt.as(&quot;createdAt&quot;),</span>
<span class="nc" id="L166">                                Expressions.as(</span>
<span class="nc" id="L167">                                        select(groupContentCommentLike.count())</span>
<span class="nc" id="L168">                                                .from(groupContentCommentLike)</span>
<span class="nc" id="L169">                                                .where(</span>
                                                        groupContentCommentLike
                                                                .groupContentComment
<span class="nc" id="L172">                                                                .eq(groupContentComment)</span>

                                                )
                                        , &quot;commentLike&quot;
                                )

                        )
<span class="nc" id="L179">                ).from(groupContentComment)</span>
<span class="nc" id="L180">                .join(groupContentComment.member, member)</span>
<span class="nc" id="L181">                .join(groupContentComment.groupContent, groupContent)</span>
<span class="nc" id="L182">                .where(</span>
<span class="nc" id="L183">                        commentUsDelYn(),</span>
<span class="nc" id="L184">                        groupEq(groupId),</span>
<span class="nc" id="L185">                        groupContentEq(groupContentId)</span>
                )
<span class="nc" id="L187">                .offset(pageable.getOffset())</span>
<span class="nc" id="L188">                .limit(pageable.getPageSize())</span>
<span class="nc" id="L189">                .orderBy(findByGroupContentCommentsSort().stream()</span>
<span class="nc" id="L190">                        .toArray(OrderSpecifier[]::new))</span>
<span class="nc" id="L191">                .fetch();</span>

<span class="nc" id="L193">        JPAQuery&lt;Long&gt; countQuery = jpaQueryFactory</span>
<span class="nc" id="L194">                .select(groupContentComment.count())</span>
<span class="nc" id="L195">                .from(groupContentComment)</span>
<span class="nc" id="L196">                .where(</span>
<span class="nc" id="L197">                        commentUsDelYn(),</span>
<span class="nc" id="L198">                        groupEq(groupId),</span>
<span class="nc" id="L199">                        groupContentEq(groupContentId)</span>
                );

<span class="nc" id="L202">        return PageableExecutionUtils.getPage(</span>
                content,
                pageable,
<span class="nc" id="L205">                countQuery::fetchOne</span>
        );
    }

    private BooleanExpression contentIsDelYn() {
<span class="nc" id="L210">        return groupContent.deletedYn.eq(false);</span>
    }

    private BooleanExpression groupEq(Long groupId) {
<span class="nc" id="L214">        return groupContent.group.id.eq(groupId);</span>
    }

    private BooleanExpression commentUsDelYn() {
<span class="nc" id="L218">        return groupContentComment.deletedYn.eq(false);</span>
    }

    private BooleanExpression groupContentEq(Long groupContentId) {
<span class="nc bnc" id="L222" title="All 2 branches missed.">        return groupContentId == null ? null : groupContent.id.eq(groupContentId);</span>
    }

    private List&lt;OrderSpecifier&gt; findByGroupContentCommentsSort() {
<span class="nc" id="L226">        StringPath aliasCommentLikes = Expressions.stringPath(&quot;commentLike&quot;);</span>

<span class="nc" id="L228">        List&lt;OrderSpecifier&gt; orders = new ArrayList&lt;&gt;(List.of(</span>
                new OrderSpecifier&lt;&gt;(DESC, aliasCommentLikes),
                new OrderSpecifier&lt;&gt;(DESC, groupContentComment.createdAt)
        ));

<span class="nc" id="L233">        return orders;</span>
    }

    private List&lt;OrderSpecifier&gt; findByGroupContentListSort(Pageable pageable) {
<span class="nc" id="L237">        List&lt;OrderSpecifier&gt; orders = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L238">        StringPath aliasContentLike =</span>
<span class="nc" id="L239">                Expressions.stringPath(&quot;contentLike&quot;);</span>

<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (!pageable.getSort().isEmpty()) {</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">            for (Sort.Order order : pageable.getSort()) {</span>
                Order direction =
<span class="nc bnc" id="L244" title="All 2 branches missed.">                        order.getDirection().isAscending() ? ASC : DESC;</span>

<span class="nc bnc" id="L246" title="All 3 branches missed.">                switch (order.getProperty()) {</span>
                    case &quot;likes&quot;:
<span class="nc" id="L248">                        orders.add(new OrderSpecifier(direction, aliasContentLike));</span>
<span class="nc" id="L249">                        orders.add(new OrderSpecifier(DESC, groupContent.createdAt));</span>
<span class="nc" id="L250">                        break;</span>
                    case &quot;date&quot; :
<span class="nc" id="L252">                        orders.add(new OrderSpecifier(direction, groupContent.createdAt));</span>
<span class="nc" id="L253">                        break;</span>
                    default:
                        break;
                }
<span class="nc" id="L257">            }</span>
        } else {
<span class="nc" id="L259">            orders.add(new OrderSpecifier(DESC, groupContent.createdAt));</span>
        }

<span class="nc" id="L262">        return orders;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>