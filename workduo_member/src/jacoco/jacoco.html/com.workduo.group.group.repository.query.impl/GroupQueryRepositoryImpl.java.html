<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GroupQueryRepositoryImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">workduo</a> &gt; <a href="index.source.html" class="el_package">com.workduo.group.group.repository.query.impl</a> &gt; <span class="el_source">GroupQueryRepositoryImpl.java</span></div><h1>GroupQueryRepositoryImpl.java</h1><pre class="source lang-java linenums">package com.workduo.group.group.repository.query.impl;

import com.querydsl.core.types.Order;
import com.querydsl.core.types.OrderSpecifier;
import com.querydsl.core.types.dsl.*;
import com.querydsl.jpa.JPQLQuery;
import com.querydsl.jpa.impl.JPAQuery;
import com.querydsl.jpa.impl.JPAQueryFactory;
import com.workduo.group.group.dto.*;
import com.workduo.group.group.repository.query.GroupQueryRepository;
import com.workduo.member.area.entity.QMemberActiveArea;
import lombok.RequiredArgsConstructor;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.data.support.PageableExecutionUtils;
import org.springframework.stereotype.Repository;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import static com.querydsl.core.types.Order.*;
import static com.querydsl.jpa.JPAExpressions.select;
import static com.workduo.area.sidoarea.entity.QSidoArea.sidoArea;
import static com.workduo.area.siggarea.entity.QSiggArea.siggArea;
import static com.workduo.group.group.entity.QGroup.group;
import static com.workduo.group.group.entity.QGroupJoinMember.groupJoinMember;
import static com.workduo.group.group.entity.QGroupLike.groupLike;
import static com.workduo.group.group.type.GroupJoinMemberStatus.GROUP_JOIN_MEMBER_STATUS_ING;
import static com.workduo.group.group.type.GroupRole.*;
import static com.workduo.group.group.type.GroupStatus.GROUP_STATUS_ING;
import static com.workduo.member.area.entity.QMemberActiveArea.memberActiveArea;
import static com.workduo.member.member.entity.QMember.member;
import static com.workduo.sport.sport.entity.QSport.sport;
import static com.workduo.sport.sportcategory.entity.QSportCategory.sportCategory;


@Repository
<span class="nc" id="L40">@RequiredArgsConstructor</span>
public class GroupQueryRepositoryImpl implements GroupQueryRepository {

    private final JPAQueryFactory jpaQueryFactory;

    @Override
    public Optional&lt;GroupDto&gt; findById(Long groupId) {
<span class="nc" id="L47">        return Optional.ofNullable(jpaQueryFactory</span>
<span class="nc" id="L48">                        .select(</span>
                                new QGroupDto(
<span class="nc" id="L50">                                        group.id.as(&quot;groupId&quot;),</span>
                                        group.name,
                                        group.limitPerson,
                                        siggArea,
                                        sidoArea,
                                        sport,
                                        sportCategory,
                                        group.introduce,
                                        group.thumbnailPath,
<span class="nc" id="L59">                                        select(groupJoinMember.count())</span>
<span class="nc" id="L60">                                                .from(groupJoinMember)</span>
<span class="nc" id="L61">                                                .where(groupJoinMember.group.eq(group)),</span>
<span class="nc" id="L62">                                        select(groupLike.count())</span>
<span class="nc" id="L63">                                                .from(groupLike)</span>
<span class="nc" id="L64">                                                .where(groupLike.group.eq(group))</span>
                                )
<span class="nc" id="L66">                        ).from(group)</span>
<span class="nc" id="L67">                        .join(group.siggArea, siggArea)</span>
<span class="nc" id="L68">                        .join(siggArea.sidoArea, sidoArea)</span>
<span class="nc" id="L69">                        .join(group.sport, sport)</span>
<span class="nc" id="L70">                        .join(sport.sportCategory, sportCategory)</span>
<span class="nc" id="L71">                        .where(group.id.eq(groupId))</span>
<span class="nc" id="L72">                        .fetchOne());</span>
    }

    @Override
    public Page&lt;GroupDto&gt; findByGroupList(
            Pageable pageable,
            Long memberId,
            ListGroup.Request condition) {

<span class="nc" id="L81">        List&lt;GroupDto&gt; content = jpaQueryFactory</span>
<span class="nc" id="L82">                .select(</span>
                        new QGroupDto(
<span class="nc" id="L84">                                group.id.as(&quot;groupId&quot;),</span>
                                group.name,
                                group.limitPerson,
                                siggArea,
                                sidoArea,
                                sport,
                                sportCategory,
                                group.introduce,
                                group.thumbnailPath,
<span class="nc" id="L93">                                Expressions.as(</span>
<span class="nc" id="L94">                                        select(groupJoinMember.count())</span>
<span class="nc" id="L95">                                        .from(groupJoinMember)</span>
<span class="nc" id="L96">                                        .where(groupJoinMember.group.eq(group))</span>
                                        , &quot;participants&quot;),
<span class="nc" id="L98">                                Expressions.as(</span>
<span class="nc" id="L99">                                        select(groupLike.count())</span>
<span class="nc" id="L100">                                        .from(groupLike)</span>
<span class="nc" id="L101">                                        .where(groupLike.group.eq(group))</span>
                                        , &quot;likes&quot;)
                        )
<span class="nc" id="L104">                ).from(group)</span>
<span class="nc" id="L105">                .join(group.siggArea, siggArea)</span>
<span class="nc" id="L106">                .join(siggArea.sidoArea, sidoArea)</span>
<span class="nc" id="L107">                .join(group.sport, sport)</span>
<span class="nc" id="L108">                .join(sport.sportCategory, sportCategory)</span>
<span class="nc" id="L109">                .where(</span>
<span class="nc" id="L110">                        groupStatusIng(),</span>
<span class="nc" id="L111">                        siggAreaEq(condition.getSgg(), memberId),</span>
<span class="nc" id="L112">                        sportEq(condition.getSportId())</span>
                )
<span class="nc" id="L114">                .offset(pageable.getOffset())</span>
<span class="nc" id="L115">                .limit(pageable.getPageSize())</span>
<span class="nc" id="L116">                .orderBy(findByGroupListSort(pageable)</span>
<span class="nc" id="L117">                        .stream().toArray(OrderSpecifier[]::new))</span>
<span class="nc" id="L118">                .fetch();</span>

<span class="nc" id="L120">        JPAQuery&lt;Long&gt; countQuery = jpaQueryFactory</span>
<span class="nc" id="L121">                .select(group.count())</span>
<span class="nc" id="L122">                .from(group)</span>
<span class="nc" id="L123">                .where(</span>
<span class="nc" id="L124">                        groupStatusIng(),</span>
<span class="nc" id="L125">                        siggAreaEq(condition.getSgg(), memberId),</span>
<span class="nc" id="L126">                        sportEq(condition.getSportId())</span>
                );

<span class="nc" id="L129">        return PageableExecutionUtils.getPage(</span>
                content,
                pageable,
<span class="nc" id="L132">                countQuery::fetchOne</span>
        );
    }

    @Override
    public Page&lt;GroupParticipantsDto&gt; findByGroupParticipantList(
            Pageable pageable,
            Long groupId) {

<span class="nc" id="L141">        List&lt;GroupParticipantsDto&gt; content = jpaQueryFactory</span>
<span class="nc" id="L142">                .select(</span>
                    new QGroupParticipantsDto(
                            member,
                            groupJoinMember
                    )
<span class="nc" id="L147">                ).from(groupJoinMember)</span>
<span class="nc" id="L148">                .join(groupJoinMember.member, member)</span>
<span class="nc" id="L149">                .where(</span>
<span class="nc" id="L150">                        groupJoinMemberStatusIng(),</span>
<span class="nc" id="L151">                        groupJoinMemberEqGroupId(groupId)</span>
                )
<span class="nc" id="L153">                .offset(pageable.getOffset())</span>
<span class="nc" id="L154">                .limit(pageable.getPageSize())</span>
<span class="nc" id="L155">                .orderBy(findByGroupParticipantListSort())</span>
<span class="nc" id="L156">                .fetch();</span>

<span class="nc" id="L158">        JPAQuery&lt;Long&gt; countQuery = jpaQueryFactory</span>
<span class="nc" id="L159">                .select(groupJoinMember.count())</span>
<span class="nc" id="L160">                .from(groupJoinMember)</span>
<span class="nc" id="L161">                .where(</span>
<span class="nc" id="L162">                        groupJoinMemberStatusIng(),</span>
<span class="nc" id="L163">                        groupJoinMemberEqGroupId(groupId)</span>
                );

<span class="nc" id="L166">        return PageableExecutionUtils.getPage(</span>
                content,
                pageable,
<span class="nc" id="L169">                countQuery::fetchOne</span>
        );
    }

    private BooleanExpression groupStatusIng() {
<span class="nc" id="L174">        return group.groupStatus.eq(GROUP_STATUS_ING);</span>
    }

    private BooleanExpression siggAreaEq(String sgg, Long memberId) {
<span class="nc bnc" id="L178" title="All 4 branches missed.">        if (sgg == null &amp;&amp; memberId == null) {</span>
<span class="nc" id="L179">            return null;</span>
<span class="nc bnc" id="L180" title="All 4 branches missed.">        } else if (sgg == null &amp;&amp; memberId != null) {</span>
<span class="nc" id="L181">            return group.siggArea.in(</span>
<span class="nc" id="L182">                    select(memberActiveArea.siggArea)</span>
<span class="nc" id="L183">                            .from(memberActiveArea)</span>
<span class="nc" id="L184">                            .join(memberActiveArea.siggArea, siggArea)</span>
<span class="nc" id="L185">                            .where(memberActiveArea.member.id.eq(memberId))</span>
            );
        } else {
<span class="nc" id="L188">            return siggArea.sgg.eq(sgg);</span>
        }
    }

    private BooleanExpression sportEq(Integer sportId) {
<span class="nc bnc" id="L193" title="All 2 branches missed.">       return sportId == null ? null : sport.id.eq(sportId);</span>
    }

    private List&lt;OrderSpecifier&gt; findByGroupListSort(Pageable pageable) {
<span class="nc" id="L197">        List&lt;OrderSpecifier&gt; orders = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L198">        StringPath aliasLikes = Expressions.stringPath(&quot;likes&quot;);</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">        if (!pageable.getSort().isEmpty()) {</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">            for (Sort.Order order : pageable.getSort()) {</span>
                Order direction =
<span class="nc bnc" id="L202" title="All 2 branches missed.">                        order.getDirection().isAscending() ? ASC : DESC;</span>
<span class="nc bnc" id="L203" title="All 3 branches missed.">                switch (order.getProperty()) {</span>
                    case &quot;likes&quot; :
<span class="nc" id="L205">                        orders.add(new OrderSpecifier&lt;&gt;(direction, aliasLikes));</span>
<span class="nc" id="L206">                        orders.add(new OrderSpecifier&lt;&gt;(DESC, group.createdAt));</span>
<span class="nc" id="L207">                        break;</span>
                    case &quot;date&quot; :
<span class="nc" id="L209">                        orders.add(new OrderSpecifier&lt;&gt;(direction, group.createdAt));</span>
<span class="nc" id="L210">                        break;</span>
                    default:
                        break;
                }
<span class="nc" id="L214">            }</span>
        } else {
<span class="nc" id="L216">            orders.add(new OrderSpecifier&lt;&gt;(DESC, group.createdAt));</span>
        }

<span class="nc" id="L219">        return orders;</span>
    }

    private BooleanExpression groupJoinMemberStatusIng() {
<span class="nc" id="L223">        return groupJoinMember.groupJoinMemberStatus.eq(GROUP_JOIN_MEMBER_STATUS_ING);</span>
    }

    private BooleanExpression groupJoinMemberEqGroupId(Long groupId) {
<span class="nc" id="L227">        return groupJoinMember.group.id.eq(groupId);</span>
    }

    private OrderSpecifier&lt;Integer&gt; findByGroupParticipantListSort() {
<span class="nc" id="L231">       return new CaseBuilder()</span>
<span class="nc" id="L232">                .when(groupJoinMember.groupRole.eq(GROUP_ROLE_LEADER)).then(1)</span>
<span class="nc" id="L233">                .when(groupJoinMember.groupRole.eq(GROUP_ROLE_STAFF)).then(2)</span>
<span class="nc" id="L234">                .otherwise(3).asc();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>